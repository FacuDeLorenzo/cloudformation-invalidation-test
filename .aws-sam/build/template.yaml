AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Blockchain Event Sourcing ecosystem template
Globals:
  Function:
    Timeout: 15
Resources:
  BlockchainEventsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: Address
        AttributeType: S
      - AttributeName: EventName
        AttributeType: S
      KeySchema:
      - AttributeName: Address
        KeyType: HASH
      - AttributeName: EventName
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
  BlockchainEventsSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: blockchain-events
      Subscription:
      - Endpoint:
          Fn::GetAtt:
          - DBWriterFunction
          - Arn
        Protocol: lambda
      - Endpoint:
          Fn::GetAtt:
          - EventsTriggerSQSQueue
          - Arn
        Protocol: sqs
  EventsTriggerSQSQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: events-trigger
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - EventsTriggerDeadLetterQueue
          - Arn
        maxReceiveCount: 3
  EventsTriggerDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: dead-events-trigger
  EventsTriggerSQSQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
      - Ref: EventsTriggerSQSQueue
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal: '*'
          Action: SQS:SendMessage
          Resource:
            Fn::GetAtt:
            - EventsTriggerSQSQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Ref: BlockchainEventsSNSTopic
  SNSPublishFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SNSPublishFunction
      Handler: index.handler
      Runtime: nodejs20.x
      MemorySize: 128
      Environment:
        Variables:
          TOPIC_ARN:
            Ref: BlockchainEventsSNSTopic
      Policies:
      - Statement:
        - Effect: Allow
          Action:
          - sns:Publish
          Resource:
          - Ref: BlockchainEventsSNSTopic
    Metadata:
      SamResourceId: SNSPublishFunction
  DBWriterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DBWriterFunction
      Handler: index.handler
      Runtime: nodejs20.x
      MemorySize: 128
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: BlockchainEventsTable
      Events:
        TriggerEvent:
          Type: SNS
          Properties:
            Topic:
              Ref: BlockchainEventsSNSTopic
      Environment:
        Variables:
          EVENTS_TABLE_NAME:
            Ref: BlockchainEventsTable
    Metadata:
      SamResourceId: DBWriterFunction
  EventsTriggerFunction:
    Type: AWS::Serverless::Function
    DependsOn: EventsTriggerSQSQueue
    Properties:
      CodeUri: EventsTriggerFunction
      Handler: index.handler
      Runtime: nodejs20.x
      MemorySize: 128
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: BlockchainEventsTable
      Events:
        TriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - EventsTriggerSQSQueue
              - Arn
    Metadata:
      SamResourceId: EventsTriggerFunction
  NotificationFunction:
    Type: AWS::Serverless::Function
    DependsOn: EventsTriggerDeadLetterQueue
    Properties:
      CodeUri: NotificationFunction
      Handler: index.handler
      Runtime: nodejs20.x
      MemorySize: 128
      Events:
        TriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - EventsTriggerDeadLetterQueue
              - Arn
    Metadata:
      SamResourceId: NotificationFunction
